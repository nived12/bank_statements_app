<!-- app/views/statement_files/show.html.erb -->
<h1>Statement file</h1>

<p>Bank account: <%= @statement_file.bank_account.display_name %></p>
<p>Status: <strong><%= @statement_file.status %></strong></p>
<% if @statement_file.parsed_json && @statement_file.parsed_json["extraction_source"] %>
  <p>Extraction: <%= @statement_file.parsed_json["extraction_source"] %></p>
<% end %>
<% if @statement_file.status == "error" && @statement_file.error_message.present? %>
  <div style="border:1px solid #f00;padding:8px;margin-bottom:12px;">
    <strong>Processing error:</strong>
    <pre style="white-space:pre-wrap;margin:0;"><%= @statement_file.error_message %></pre>
  </div>
<% end %>

<p><%= link_to "Download file", rails_blob_path(@statement_file.file, disposition: "attachment") %></p>

<% if @statement_file.parsed_json && @statement_file.parsed_json["transactions"] %>
  <h2>Transactions</h2>
  <table border="1" cellpadding="6">
    <thead><tr>
      <th>Date</th><th>Description</th><th>Amount</th><th>Type</th><th>Bank entry</th>
    </tr></thead>
    <tbody>
      <% @statement_file.parsed_json["transactions"].each do |t| %>
        <tr>
          <td><%= t["date"] %></td>
          <td><%= t["description"] %></td>
          <td><%= t["amount"] %></td>
          <td>
            <%= t["transaction_type"] %>
            <%= confidence_badge(t["transaction_type_confidence"]) %>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
            <%= [t["category"], t["sub_category"]].compact.join(" / ") %>
            <%= confidence_badge(t["category_confidence"]) %>
          </td>
          <td><%= t["bank_entry_type"] %></td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% end %>
